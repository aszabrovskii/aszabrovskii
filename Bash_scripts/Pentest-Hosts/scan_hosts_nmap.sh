#!/bin/bash
#########################################################################################
# Script author                                                                         #
# Aleksandr Zabrovskii                                                                  #
# Telegram: @auditorx                                                                   #
# The script is designed to scan a list of hosts from a received DNS A record request.  #
# The scan is performed using nmap and generates reports that are sent by email.        #
#########################################################################################
REPORT=nmap_scan
FILES=$HOME/sh_scripts/
DIRECTORY=$HOME/py_scripts/send_report_template_nmap.py
RECORD=/scripts/ResourceRecord_A/staging_list.txt

for VAR_HOST in $(< $HOME$RECORD); do
  export DIR="$VAR_HOST"

  echo "#################################################"
  echo "###############   Start Scanning   ##############"
  echo "#################################################"

  sudo nmap -vvvv -oA ${VAR_HOST}.log $VAR_HOST

  # Conversion. xsltproc nmap.scanme.org.log.xml -o nmap.scanme.org.html
  if [ "$?" -eq "0" ]; then xsltproc ${VAR_HOST}.log.xml -o ${REPORT}.html; fi

  echo ${VAR_HOST} > $HOME/py_scripts/subject_host.txt

  # Running a Python script and sending a report to the mail
  if [ "$?" -eq "0" ]; then python3 ${DIRECTORY}; fi

  # Deleting unnecessary files
  # nmap.scanme.org.html
  # nmap.scanme.org.log.gnmap
  # nmap.scanme.org.log.nmap
  # nmap.scanme.org.log.xml
  if [ "$?" -eq "0" ]; then sudo rm ${FILES}*.html *.gnmap *.nmap *.xml; fi

  rm $HOME/py_scripts/subject_host.txt

  echo "#################################################"
  echo "################   End of Scan    ###############"
  echo "#################################################"

done
