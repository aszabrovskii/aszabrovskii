#!/bin/bash
############################################################################
# Script author                                                            #
# Aleksandr Zabrovskii                                                     #
# Telegram: @auditorx                                                      #
# This script will check the record to the file in the next 20 seconds.    #
# If there is no record in the specified interval,                         #
# the script is run to send reports by e-mail.                             #
############################################################################
FILE=zaproxy_scan.html
FOUND=$(find $HOME/sh_scripts/ -name $FILE)
DIRECTORY=$HOME/py_scripts/send_report_template_owasp.py

while [[ $FOUND != $FILE ]]; #SEARCH
do
    sleep 10
    if ((`date +%s` - `date +%s -r "$FILE"` > 20)) 2>/dev/null; then
        #echo "Hasn't changed in 20 seconds."

        #Sends mail
        python3 ${DIRECTORY}

        #Deletes the file zaproxy_scan.html
        if [ "$?" -eq "0" ]; then rm ${FILE}; fi
        
        #Deletes the file subject_web.txt
        rm $HOME/py_scripts/subject_web.txt

        #Ctrl + C zaproxy
        echo "Search PID"
        echo $(sudo ./kill_pid.sh) >/dev/null; #echo "ZAPROXY Stop"
        
        else

        continue
    fi

exit
done
